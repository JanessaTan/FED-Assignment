<!-- Student ID - S10275480F 
Student Name -Nicole Agnes Sim Hui En -->

<!-- Customize Order Page - Let customers add items to their cart and customize them -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Page title in browser tab -->
  <title>Customize – HawkerHub</title>
  <!-- Base styles (buttons, colors, fonts) -->
  <link rel="stylesheet" href="../css/base.css">
  <!-- Customize page specific styles (form layout, checkboxes) -->
  <link rel="stylesheet" href="../css/customize.css">
</head>
<body>

<!-- Check if user is logged in -->
<script src="../JS/Auth.js"></script>

<!-- Main content area -->
<main class="container">
  <!-- White card to hold the form -->
  <div class="card">
    <!-- Page heading -->
    <h2>Customize Your Order</h2>
    <!-- Short description of what this page does -->
    <p class="muted">Make your dish exactly how you like it!</p>

    <!-- The customize form -->
    <form id="cf">
      <!-- First section: Item details (name, price, quantity) -->
      <div class="customize-section">
        <!-- Row with item name and quantity -->
        <div class="row">
          <!-- Item name field (not editable) -->
          <div style="flex:1">
            <label>Selected Item</label>
            <input id="itemName" readonly>
          </div>
          <!-- How many of this item they want -->
          <div>
            <label>Quantity</label>
            <input id="qty" type="number" min="1" value="1" max="10">
          </div>
        </div>

        <!-- Row with item price and total price -->
        <div class="row">
          <!-- Price per one item (not editable) -->
          <div style="flex:1">
            <label>Price per item</label>
            <input id="itemPrice" readonly>
          </div>
          <!-- Total cost (not editable, updates automatically) -->
          <div style="flex:1">
            <label>Total Price</label>
            <input id="totalprice" readonly>
          </div>
        </div>
      </div>

      <!-- Second section: Customization options -->
      <div class="customize-section">
        <h3>Customization Options</h3>

        <!-- Spice level dropdown -->
        <div class="row">
          <div style="flex:1">
            <label>Spice Level</label>
            <select id="spiceLevel">
              <option value="normal">Normal</option>
              <option value="mild">Less Spicy</option>
              <option value="extra">Extra Spicy</option>
              <option value="none">No Spicy</option>
            </select>
          </div>
        </div>

        <!-- Special instructions text area -->
        <div class="row">
          <div style="flex:1">
            <label>Special Instructions (Optional)</label>
            <!-- Textarea for things like "no onions" or "extra sauce" -->
            <textarea id="notes" rows="3" maxlength="200"></textarea>
          </div>
        </div>
      </div>

      <!-- Buttons at bottom -->
      <div class="button-group">
        <!-- Save the customizations and add to cart -->
        <button type="submit" class="btn">Save</button>
        <!-- Go back to checkout page -->
        <a class="btn secondary" href="Checkout.html">Back</a>
      </div>
    </form>
  </div>
</main>

<!-- JavaScript to handle the customize page logic -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  'use strict';

  // Helper function to get element by ID
  function $(id) { 
    const el = document.getElementById(id);
    if (!el) {
      console.error('Element not found:', id);
    }
    return el;
  }
  
  // Helper to format numbers as currency
  function fmt(num) { 
    return '$' + parseFloat(num || 0).toFixed(2); 
  }

  // Get the cart data from browser storage
  function getStore() {
    try {
      return JSON.parse(localStorage.getItem('store')) || { cart: [] };
    } catch (e) {
      console.error('Error parsing store:', e);
      return { cart: [] };
    }
  }

  // Save the updated cart back to browser storage
  function saveStore(store) {
    try {
      localStorage.setItem('store', JSON.stringify(store));
    } catch (e) {
      console.error('Error saving store:', e);
    }
  }

  // Get form elements - with safety checks
  const itemNameEl = $('itemName');
  const itemPriceEl = $('itemPrice');
  const totalPriceEl = $('totalprice');
  const qtyEl = $('qty');
  const notesEl = $('notes');
  const spiceLevelEl = $('spiceLevel');
  const form = $('cf');

  // Safety check - all required fields must exist
  if (!itemNameEl || !qtyEl || !form) {
    console.error('Critical form elements missing!');
    console.error('itemNameEl:', itemNameEl, 'qtyEl:', qtyEl, 'form:', form);
    alert('Form error. Please refresh the page.');
    return;
  }

  // Check if we're in EDIT mode (customer editing existing cart item)
  let isEditMode = false;
  let editingIndex = null;
  let item = null;

  try {
    const editIndexStr = localStorage.getItem('editingCartIndex');
    if (editIndexStr !== null && editIndexStr !== '') {
      isEditMode = true;
      editingIndex = parseInt(editIndexStr, 10);
      console.log('Edit mode active - cart index:', editingIndex);
    }
  } catch (e) {
    console.error('Error checking edit mode:', e);
  }

  // Get the store and the item to customize
  const store = getStore();

  if (isEditMode && store.cart && store.cart[editingIndex]) {
    // We're editing - load the existing item
    item = store.cart[editingIndex];
    console.log('Loaded item from cart:', item.name);
  } else if (isEditMode) {
    // Edit mode but item not found
    console.error('Cart item not found at index:', editingIndex);
    console.error('Cart contents:', store.cart);
    alert('Error: Item not found in cart. Redirecting to checkout...');
    window.location.href = 'Checkout.html';
    return;
  } else {
    // Not in edit mode - should have received item data some other way
    console.warn('Not in edit mode and no item provided');
    alert('Error: No item selected. Redirecting to checkout...');
    window.location.href = 'Checkout.html';
    return;
  }

  // Safely set form field values
  if (item && item.name) {
    itemNameEl.value = item.name;
  }

  if (item && item.price && itemPriceEl) {
    itemPriceEl.value = fmt(item.price);
  }

  if (item && item.qty && qtyEl) {
    qtyEl.value = item.qty;
  } else if (qtyEl) {
    qtyEl.value = 1;
  }

  // Restore spice level and notes if they were set before
  if (item && item.notes) {
    const noteParts = item.notes.split('; ');
    
    noteParts.forEach(part => {
      if (part === 'Less Spicy' && spiceLevelEl) {
        spiceLevelEl.value = 'mild';
      } else if (part === 'Extra Spicy' && spiceLevelEl) {
        spiceLevelEl.value = 'extra';
      } else if (part === 'No Spicy' && spiceLevelEl) {
        spiceLevelEl.value = 'none';
      } else if (notesEl && part && part !== 'Less Spicy' && part !== 'Extra Spicy' && part !== 'No Spicy') {
        notesEl.value = part;
      }
    });
  }

  // Function to update total price when quantity changes
  function updateTotalPrice() {
    if (!qtyEl || !totalPriceEl || !item) return;
    
    const qty = Math.max(1, parseInt(qtyEl.value || 1, 10));
    const total = item.price * qty;
    totalPriceEl.value = fmt(total);
  }

  // Calculate total on page load
  updateTotalPrice();

  // Recalculate when quantity changes
  if (qtyEl) {
    qtyEl.addEventListener('change', updateTotalPrice);
    qtyEl.addEventListener('input', updateTotalPrice);
  }

  // Handle form submission
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // Get the updated quantity
      const qty = Math.max(1, parseInt(qtyEl.value || 1, 10));
      
      // Collect customization notes
      const customizations = [];

      // Add spice level if selected
      if (spiceLevelEl && spiceLevelEl.value !== 'normal') {
        const spiceMap = {
          'mild': 'Less Spicy',
          'extra': 'Extra Spicy',
          'none': 'No Spicy'
        };
        if (spiceMap[spiceLevelEl.value]) {
          customizations.push(spiceMap[spiceLevelEl.value]);
        }
      }

      // Add special instructions if provided
      if (notesEl && notesEl.value.trim()) {
        customizations.push(notesEl.value.trim());
      }

      // Combine all notes
      const notes = customizations.join('; ');

      // Update the item in the cart
      if (isEditMode && editingIndex !== null && store.cart && store.cart[editingIndex]) {
        store.cart[editingIndex].qty = qty;
        store.cart[editingIndex].notes = notes;
        saveStore(store);

        // Clean up edit mode flags
        try {
          localStorage.removeItem('editingCartIndex');
        } catch (e) {
          console.error('Error removing editingCartIndex:', e);
        }

        console.log('✅ Item updated:', store.cart[editingIndex].name);
        alert('✅ Item updated!');
      } else {
        console.error('Cannot save - not in proper edit mode');
        alert('Error saving item. Please try again.');
        return;
      }

      // Redirect to checkout
      window.location.href = 'Checkout.html';
    });
  }

  console.log('✅ Customize page loaded successfully');
});
</script>

</body>
</html>